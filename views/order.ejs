<!DOCTYPE html>
<html lang="en">
<head>
    <title>Order</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script>
        const userPoints = <%= user.points %>;
        let currentUserPoints = userPoints;

        function addToOrder(productId, productName, productPrice, isAddon = false) {
            const orderList = document.getElementById('order-list');
            const orderData = JSON.parse(localStorage.getItem('orderData')) || { items: [], subtotal: 0 };

            // Add item to data
            const newItem = { productId, productName, productPrice, isAddon };
            orderData.items.push(newItem);
            orderData.subtotal += productPrice;
            localStorage.setItem('orderData', JSON.stringify(orderData));

            // Create list element
            const li = document.createElement('li');
            li.classList.add("order-item");

            if (isAddon) {
                li.style.marginLeft = "20px";
                li.style.fontSize = "0.9em";
            }

            li.innerHTML = `
                ${productName} - $${productPrice.toFixed(2)}
                <button class="remove-item" onclick="removeItem(${orderData.items.length - 1})">X</button>
            `;

            orderList.appendChild(li);
            updateTotals();

            
        }

        function updateTotals() {
            const orderData = JSON.parse(localStorage.getItem('orderData')) || { items: [], subtotal: 0 };

            const subtotal = orderData.subtotal;
            const tax = subtotal * 0.0825;
            const total = subtotal + tax;

            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('tax').textContent = tax.toFixed(2);
            document.getElementById('total').textContent = total.toFixed(2);
        }

        function removeItem(index) {
            let orderData = JSON.parse(localStorage.getItem('orderData'));
            if (!orderData) return;

            const removed = orderData.items[index];
            orderData.subtotal -= removed.productPrice;

            orderData.items.splice(index, 1);

            localStorage.setItem('orderData', JSON.stringify(orderData));

            renderOrderList();
        }

        function renderOrderList() {
            const orderList = document.getElementById('order-list');
            orderList.innerHTML = "";

            const orderData = JSON.parse(localStorage.getItem('orderData')) || { items: [], subtotal: 0 };

            orderData.items.forEach((item, index) => {
                const li = document.createElement('li');
                li.classList.add("order-item");

                if (item.isAddon) {
                    li.style.marginLeft = "20px";
                    li.style.fontSize = "0.9em";
                }

                li.innerHTML = `
                    ${item.productName} - $${item.productPrice.toFixed(2)}
                    <button class="remove-item" onclick="removeItem(${index})">X</button>
                `;

                orderList.appendChild(li);
            });

            updateTotals();
        }


        function loadOrder() {
            renderOrderList();
        }

        function clearOrder() {
            // Clear order data from localStorage
            localStorage.removeItem('orderData');

            // Reset the order list and totals
            document.getElementById('order-list').innerHTML = '';
            document.getElementById('subtotal').textContent = '0.00';
            document.getElementById('tax').textContent = '0.00';
            document.getElementById('total').textContent = '0.00';
        }

        async function checkoutOrder() {
            const orderData = JSON.parse(localStorage.getItem('orderData'));
            if (!orderData || orderData.items.length === 0) {
                alert("Your order is empty!");
                return;
            }

            // Populate modal with order items
            const confirmList = document.getElementById("confirm-order-list");
            confirmList.innerHTML = "";

            orderData.items.forEach(item => {
                const li = document.createElement("li");
                li.textContent = `${item.productName} - $${item.productPrice.toFixed(2)}`;
                if (item.isAddon) {
                    li.style.marginLeft = "20px";
                    li.style.fontSize = "0.9em";
                }
                confirmList.appendChild(li);
            });

            // Fill totals
            const tax = orderData.subtotal * 0.0825;
            const total = orderData.subtotal + tax;

            document.getElementById("confirm-subtotal").textContent = orderData.subtotal.toFixed(2);
            document.getElementById("confirm-tax").textContent = tax.toFixed(2);
            document.getElementById("confirm-total").textContent = total.toFixed(2);

            // Show modal
            document.getElementById("confirmModal").classList.remove("hidden");

            //calculate points added
            let points = Math.round(total) * 100;
            let totalToPoints = total * 1000;

            document.getElementById("confirm-totalToPoints").textContent = totalToPoints.toFixed(2);
            document.getElementById("confirm-points").textContent = currentUserPoints;

            // Confirm button
            document.getElementById("confirmYes").onclick = async () => {
                try {
                    const res = await fetch('/checkout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            orderItems: orderData.items,
                            subtotal: orderData.subtotal,
                            points: points
                        })
                    });

                    const data = await res.json();
                    if (data.success) {
                        alert(`Order placed successfully! Order ID: ${data.order_id}`);
                        clearOrder();
                        document.getElementById("confirmModal").classList.add("hidden");
                        window.location.href = "/";
                    } else {
                        alert("Checkout failed: " + data.message);
                    }
                } catch (err) {
                    console.error('Checkout error:', err);
                    alert("An error occurred while checking out.");
                }
            };

            //Show 

            // Cancel button closes modal
            document.getElementById("confirmNo").onclick = () => {
                document.getElementById("confirmModal").classList.add("hidden");
            };

            document.getElementById("confirmPoints").onclick = () => {
                openPointsModal(total);
            };
        }



        function showAddons(productId, productName, productPrice) {
             const addonsSection = document.getElementById(`addons-section-${productId}`);
              const isCurrentlyVisible = addonsSection.classList.contains('show');
               // Hide all other add-on sections
               document.querySelectorAll('.addons-container').forEach(section => {
                 if (section !== addonsSection) {
                     section.classList.remove('show');
                     }
                 });
                 
                 if (!isCurrentlyVisible) {
                     addonsSection.classList.add('show');
                     // Save selected product (only when expanding)
                     const selectedProduct = { id: productId, name: productName, price: productPrice };
                     localStorage.setItem('selectedProduct', JSON.stringify(selectedProduct));
                } else {
                    // Collapse this section
                    addonsSection.classList.remove('show');
                    localStorage.removeItem('selectedProduct');
                    // Clear all selected checkboxes in this section
                    addonsSection.querySelectorAll('.addon-checkbox').forEach(cb => cb.checked = false);
                }
        }


        function addProductWithAddons(productId) {

            // selectedProduct stored when addons panel is opened
            const selectedProduct = JSON.parse(localStorage.getItem('selectedProduct'));
            const product = selectedProduct && String(selectedProduct.id) === String(productId) ? selectedProduct : null;
            if (!product) {
                // fallback: sometimes we call addProductWithAddons without selectedProduct, abort safely
                console.warn('No selectedProduct found for productId', productId);
                return;
            }

            const qtyInput = document.getElementById(`quantityInput-${productId}`);
            const quantity = Math.max(1, parseInt(qtyInput?.value || '1', 10));

            const addonsSection = document.getElementById(`addons-section-${productId}`);
            const selectedAddons = Array.from(addonsSection.querySelectorAll('.addon-checkbox:checked'));

            // Add product + addons for each quantity unit
            for (let i = 0; i < quantity; i++) {
                // add main product
                addToOrder(product.id, product.name, product.price, false);

                // add selected add-ons (all of them)
                selectedAddons.forEach(cb => {
                    const addonId = cb.dataset.id;
                    const addonName = cb.dataset.name;
                    const addonPrice = parseFloat(cb.dataset.price);
                    addToOrder(addonId, addonName, addonPrice, true);
                });
            }

            // Clear checkboxes only AFTER loop
            selectedAddons.forEach(cb => cb.checked = false);

            // Reset quantity input to 1
            if (qtyInput) qtyInput.value = 1;

            // Collapse the panel
            addonsSection.classList.remove('show');
            localStorage.removeItem('selectedProduct');

        }

        function handleAddToOrder(productId, productName, productPrice) {
            const addonsSection = document.getElementById(`addons-section-${productId}`);

            // If addons are showing, call addProductWithAddons
            if (addonsSection.classList.contains('show')) {
                addProductWithAddons(productId, productName, productPrice);
            } else {
                addToOrder(productId, productName, productPrice);
            }
        }

        //function to show points modal for users
        let pointsToRedeem = 0; 
        const POINTS_PER_DOLLAR = 100;

        function openPointsModal(orderTotal) {
            const maxDiscountDollars = Math.min(orderTotal, currentUserPoints / POINTS_PER_DOLLAR);

            const pointsToUse = Math.floor(maxDiscountDollars * POINTS_PER_DOLLAR);
            const discount = pointsToUse / POINTS_PER_DOLLAR;
            newTotal = (orderTotal - discount).toFixed(2);
            const remainingPoints = currentUserPoints - pointsToUse;
            newTotal = clampMoney(newTotal);

            // Fill modal text
            document.getElementById("points-order-total").textContent = orderTotal.toFixed(2);
            document.getElementById("points-current").textContent = currentUserPoints;
            document.getElementById("points-used").textContent = pointsToUse;
            document.getElementById("points-new-total").textContent = newTotal;
            document.getElementById("points-remaining").textContent = remainingPoints;

            pointsToRedeem = pointsToUse;

            document.getElementById("pointsModal").classList.remove("hidden");

            document.getElementById("pointsConfirmYes").onclick = () => {
                currentUserPoints = remainingPoints;
                document.getElementById("pointsModal").classList.add("hidden");
                document.getElementById("confirm-total").textContent = newTotal;
                document.getElementById("confirm-points").textContent = currentUserPoints;
                document.getElementById("total").textContent = newTotal;
            };

            document.getElementById("pointsConfirmNo").onclick = () => {
                document.getElementById("pointsModal").classList.add("hidden");
                pointsToRedeem = 0;  
            };
        }

        //help prevent total from being 0.01 when it should be 0
        function clampMoney(value) {
            const num = Number(value) || 0;     
            if (num < 0.05) return 0.00;             
            return Math.round(num * 100) / 100;
        }




        // Load order data on page load
        window.onload = loadOrder;
    </script>
</head>
<body>
    <div>
        <h1>Order Page</h1>

        <!-- Constant Category Bar -->
        <div class="category-bar">
            <ul>
                <% groupedProducts.forEach(group => { %>
                    <li>
                        <a href="/order?category=<%= group.categoryId %>"><%= group.category %></a>
                    </li>
                <% }); %>
                <li class="lang-dropdown no-translate">
                    <button class="translate-btn" id="translateBtn">
                        <img src="/Translate.png" alt="Translate" class="Translate-img" id="translateImg">
                    </button>
                    <div id="langMenu" class="lang-menu hidden">
                        <select id="langSel" aria-label="Select language">
                          <option value="en" selected>English</option>
                          <option value="zh">中文</option>
                          <option value="es">Español</option>
                          <option value="fr">Français</option>
                          <option value="ja">日本語</option>
                        </select>
                    </div>
                </li>
            </ul>
        </div>


        <!-- Display products for the selected category -->
        <div class="order-center-container">
            <% if (selectedCategory) { %>
                <% const selectedGroup = groupedProducts.find(group => group.categoryId == selectedCategory); %>
                <% if (selectedGroup) { %>
                    <div class="products">
                        <h2><%= selectedGroup.category %></h2>
                        <ul>
                            <% selectedGroup.products.forEach((product) => { %>
                                <li>
                                    <strong><%= product.name %></strong> - $<%= product.price %>
                                    <button class="orderButtons" onclick="showAddons('<%= product.id %>', '<%= product.name %>', <%= product.price %>)">Select Add-ons</button>
                                    <button class="orderButtons" onclick="handleAddToOrder('<%= product.id %>', '<%= product.name %>', <%= product.price %>)">Add to Order</button>
                                    <div id="addons-section-<%= product.id %>" class="addons-container">  
                                        <h2>Select Add-ons</h2>
                                        <ul>
                                            <% addons.forEach(addon => { %>
                                                <li>
                                                    <input type="checkbox" class="addon-checkbox" data-id="<%= addon.id %>" data-name="<%= addon.name %>" data-price="<%= addon.price %>">
                                                    <strong><%= addon.name %></strong> - $<%= addon.price.toFixed(2) %>
                                                    
                                                </li>
                                                
                                            <% }); %>
                                            </ul>
                                        <div class="quantitySelector">
                                            <label for="quantityInput-<%= product.id %>">Quantity:</label>
                                            <input type="number" id="quantityInput-<%= product.id %>" min="1" value="1" style="width:70px;">
                                        </div>
                                        <button class="orderButtons" onclick="addProductWithAddons('<%= product.id %>')">Add to Order</button>
                                    </div>
                                    
                                </li>
                            <% }); %>
                        </ul>
                        
                    </div>
                <% } else { %>
                    <p>No products found for the selected category.</p>
                <% } %>
            <% } %>
            
        </div>

        <!-- Order Summary -->
         <div class="order-summary">
            <h2>Order Summary</h2>
            <ul id="order-list"></ul>
            <p>Subtotal: $<span id="subtotal">0.00</span></p>
            <p>Tax (8.25%): $<span id="tax">0.00</span></p>
            <p>Total: $<span id="total">0.00</span></p>
            <button class="checkout"onclick="checkoutOrder()">Checkout</button>
        </div>
        <button class="clear-order" onclick="clearOrder()">Clear Order</button>
        <button class="cancel-order" onclick="clearOrder(); window.location.href='/'">Cancel Order</button>
    </div>

    <script type="module" src="/langSelect.js"></script>
    <script src="/index.js"></script>

    <div id="confirmModal" class="modal-order hidden">
        <div class="modal-order-content">
            <h2>Confirm Your Order</h2>
            <ul id="confirm-order-list"></ul>
            <p>Subtotal: $<span id="confirm-subtotal">0.00</span></p>
            <p>Tax: $<span id="confirm-tax">0.00</span></p>
            <p>Total: $<span id="confirm-total">0.00</span></p>
            <p>Total converted to points: <span id="confirm-totalToPoints">0.00</span></p>
            <p>Your points <span id="confirm-points">0.00</span></p>
            <div class="modal-order-buttons">
                <button id="confirmYes">Confirm</button>
                <button id="confirmNo">Cancel</button>
                <button id="confirmPoints"> Use Points </button>
            </div>
        </div>
    </div>

    <div id="pointsModal" class="modal-order hidden">
        <div class="modal-order-content">
            <h2>Use Points?</h2>
            <p>Order total: $<span id="points-order-total">0.00</span></p>
            <p>Your current points: <span id="points-current">0</span></p>
            <p>Points to use: <span id="points-used">0</span></p>
            <p>New total after points: $<span id="points-new-total">0.00</span></p>
            <p>Points remaining: <span id="points-remaining">0</span></p>

            <div class="modal-order-buttons">
            <button id="pointsConfirmYes">Apply Points</button>
            <button id="pointsConfirmNo">Cancel</button>
            </div>
        </div>
    </div>

</body>
</html>