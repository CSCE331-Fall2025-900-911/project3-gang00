<!DOCTYPE html>
<html lang="en">
<head>
    <title>Order</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script>
        function addToOrder(productId, productName, productPrice, isAddon = false) {
            const orderList = document.getElementById('order-list');

            const orderItem = document.createElement('li');
            orderItem.textContent = `${productName} - $${productPrice.toFixed(2)}`;

            if (isAddon) {
                orderItem.style.marginLeft = '20px'; // Indent for sub-items
                orderItem.style.fontSize = '0.9em'; // Smaller font for add-ons
            }

            orderList.appendChild(orderItem);

            const subtotalElement = document.getElementById('subtotal');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total');

            const currentSubtotal = parseFloat(subtotalElement.textContent);
            const newSubtotal = currentSubtotal + productPrice;
            const tax = newSubtotal * 0.0825;
            const total = newSubtotal + tax;

            subtotalElement.textContent = newSubtotal.toFixed(2);
            taxElement.textContent = tax.toFixed(2);
            totalElement.textContent = total.toFixed(2);

            // Persist order data in localStorage
            const orderData = JSON.parse(localStorage.getItem('orderData')) || { items: [], subtotal: 0 };
            orderData.items.push({ productId, productName, productPrice, isAddon });
            orderData.subtotal = newSubtotal;
            localStorage.setItem('orderData', JSON.stringify(orderData));
        }

        function loadOrder() {
            const orderData = JSON.parse(localStorage.getItem('orderData'));
            if (orderData) {
                const orderList = document.getElementById('order-list');
                const subtotalElement = document.getElementById('subtotal');
                const taxElement = document.getElementById('tax');
                const totalElement = document.getElementById('total');

                orderData.items.forEach(item => {
                    const orderItem = document.createElement('li');
                    orderItem.textContent = `${item.productName} - $${item.productPrice.toFixed(2)}`;

                    if (item.isAddon) {
                        orderItem.style.marginLeft = '20px'; // Indent for sub-items
                        orderItem.style.fontSize = '0.9em'; // Smaller font for add-ons
                    }

                    orderList.appendChild(orderItem);
                });

                const tax = orderData.subtotal * 0.0825;
                const total = orderData.subtotal + tax;

                subtotalElement.textContent = orderData.subtotal.toFixed(2);
                taxElement.textContent = tax.toFixed(2);
                totalElement.textContent = total.toFixed(2);
            }
        }

        function clearOrder() {
            // Clear order data from localStorage
            localStorage.removeItem('orderData');

            // Reset the order list and totals
            document.getElementById('order-list').innerHTML = '';
            document.getElementById('subtotal').textContent = '0.00';
            document.getElementById('tax').textContent = '0.00';
            document.getElementById('total').textContent = '0.00';
        }

        async function checkoutOrder() {
            const orderData = JSON.parse(localStorage.getItem('orderData'));
            if (!orderData || orderData.items.length === 0) {
                alert("Your order is empty!");
                return;
            }

            try {
                const res = await fetch('/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    orderItems: orderData.items,
                    subtotal: orderData.subtotal
                })
                });

                const data = await res.json();
                if (data.success) {
                    alert(`Order placed successfully! Order ID: ${data.order_id}`);
                    clearOrder(); // reset local storage and UI
                } else {
                    alert("Checkout failed: " + data.message);
                }
            } catch (err) {
                console.error('Checkout error:', err);
                alert("An error occurred while checking out.");
            }
        }


        function showAddons(productId, productName, productPrice) {
             const addonsSection = document.getElementById(`addons-section-${productId}`);
              const isCurrentlyVisible = addonsSection.classList.contains('show');
               // Hide all other add-on sections
               document.querySelectorAll('.addons-container').forEach(section => {
                 if (section !== addonsSection) {
                     section.classList.remove('show');
                     }
                 });
                 
                 if (!isCurrentlyVisible) {
                     addonsSection.classList.add('show');
                     // Save selected product (only when expanding)
                     const selectedProduct = { id: productId, name: productName, price: productPrice };
                     localStorage.setItem('selectedProduct', JSON.stringify(selectedProduct));
                } else {
                    // Collapse this section
                    addonsSection.classList.remove('show');
                    localStorage.removeItem('selectedProduct');
                    // Clear all selected checkboxes in this section
                    addonsSection.querySelectorAll('.addon-checkbox').forEach(cb => cb.checked = false);
                }
        }

        function addProductWithAddons(productId) {
           const selectedProduct = JSON.parse(localStorage.getItem('selectedProduct'));
            if (!selectedProduct) return;

            // Add main product
            addToOrder(selectedProduct.id, selectedProduct.name, selectedProduct.price);

            // Add selected add-ons
            const addonsSection = document.getElementById(`addons-section-${productId}`);
            const selectedAddons = addonsSection.querySelectorAll('.addon-checkbox:checked');
            selectedAddons.forEach(cb => {
                const addonId = cb.dataset.id;
                const addonName = cb.dataset.name;
                const addonPrice = parseFloat(cb.dataset.price);
                addToOrder(addonId, addonName, addonPrice, true);
                cb.checked = false; // clear checkbox
            });

            showAddons(productId); // Collapse the add-ons section after adding to order
            
        }

        // Load order data on page load
        window.onload = loadOrder;
    </script>
</head>
<body>
    <div>
        <h1>Order Page</h1>

        <!-- Constant Category Bar -->
        <div class="category-bar">
            <ul>
                <% groupedProducts.forEach(group => { %>
                    <li>
                        <a href="/order?category=<%= group.categoryId %>"><%= group.category %></a>
                    </li>
                <% }); %>
                <li class="lang-dropdown no-translate">
                    <button class="translate-btn" id="translateBtn">
                        <img src="/Translate.png" alt="Translate" class="Translate-img" id="translateImg">
                    </button>
                    <div id="langMenu" class="lang-menu hidden">
                        <select id="langSel" aria-label="Select language">
                          <option value="en" selected>English</option>
                          <option value="zh">中文</option>
                          <option value="es">Español</option>
                          <option value="fr">Français</option>
                          <option value="ja">日本語</option>
                        </select>
                    </div>
                </li>
            </ul>
        </div>


        <!-- Display products for the selected category -->
        <div class="order-center-container">
            <% if (selectedCategory) { %>
                <% const selectedGroup = groupedProducts.find(group => group.categoryId == selectedCategory); %>
                <% if (selectedGroup) { %>
                    <div class="products">
                        <h2><%= selectedGroup.category %></h2>
                        <ul>
                            <% selectedGroup.products.forEach((product) => { %>
                                <li>
                                    <strong><%= product.name %></strong> - $<%= product.price %>
                                    <button onclick="showAddons('<%= product.id %>', '<%= product.name %>', <%= product.price %>)">Select Add-ons</button>
                                    <div id="addons-section-<%= product.id %>" class="addons-container">  
                                        <h2>Select Add-ons</h2>
                                        <ul>
                                            <% addons.forEach(addon => { %>
                                                <li>
                                                    <input type="checkbox" class="addon-checkbox" data-id="<%= addon.id %>" data-name="<%= addon.name %>" data-price="<%= addon.price %>">
                                                    <strong><%= addon.name %></strong> - $<%= addon.price.toFixed(2) %>
                                                    
                                                </li>
                                                
                                            <% }); %>
                                            <button onclick="addProductWithAddons('<%= product.id %>')">Add to Order</button> 
                                        </ul>
                                        
                                    </div>
                                </li>
                            <% }); %>
                        </ul>
                        
                    </div>
                <% } else { %>
                    <p>No products found for the selected category.</p>
                <% } %>
            <% } %>
            
        </div>

        <!-- Order Summary -->
         <div class="order-summary">
            <h2>Order Summary</h2>
            <ul id="order-list"></ul>
            <p>Subtotal: $<span id="subtotal">0.00</span></p>
            <p>Tax (8.25%): $<span id="tax">0.00</span></p>
            <p>Total: $<span id="total">0.00</span></p>
            <button class="checkout"onclick="checkoutOrder()">Checkout</button>
        </div>
        <button class="clear-order" onclick="clearOrder()">Clear Order</button>
        <button class="cancel-order" onclick="clearOrder(); window.location.href='/'">Cancel Order</button>
    </div>

    <script type="module" src="/langSelect.js"></script>
    <script src="/index.js"></script>
</body>
</html>